# TonAPI Auth

## TON authorization overview
### 1) Redirect user to the auth page
To perform auth user must be redirected to special page where auth can be checked
tonapi.io/login?{params}

**Params supported:**
* **redirect_url** – *[optional]* *string*, url where user will be redirected after successful auth
* **is_mobile** - *[optional]* *1 | 0*, flag which indicates auth user device type, when this flag's value equals *1* qr code will be not rendered on client app, and auth gate will wait for client return action after tonkeeper success login (this flow is recommended to mobile user apps)
* **callback_url** – *[optional]* *string*, url which will be called from backend in after successfull auth
* **app_id** – *string*, identifier of the app. Name and icon of the app will be used on the authorization page. (not supported yet)


One of the params **redirect_url** or **callback_url** must be passed. Please note that **authToken** wich you will get after authorization flow is **ONE TIME USE**, **SHORT LIVING** token wich should be exchanged to persistent token serverside via tonapi.io/v1/auth. Just receiving authToken is not a proof of successful user authorisation and can be possibly swapped or be stolen by attacker.

In case of success the **callback_url** or **redirect_url** will be triggered with following GET params added:
* **success** – boolean, true in case if auth was successfully performed (not supported yet)
* **auth_token** – *[optional]* *string*, one-time-use token  
* **error_code** – *[optional]* *string*, in case of success=false short text code of error (not supported yet)
* **error_text** – *[optional]* *string*, in case of success=false text human readable description of error (not supported yet)

**Examples:**
```JSON
{
    "success": true,
    "auth_token": "abcd..."
}
```
```JSON
{
    "success": false,
    "error_code": "auth_rejected",
    "error_text": "User canceled authorization"
}
```

### 2) Fetching persistant token via tonapi.io/v1/auth method.
After successfully obtaining **auth_token** via process described below /auth method should be called from server side to check that the **auth_token** is valid.

Authorization header must be passed to this method the same way as any other methods in tonapi.io API. Token can be obtained with t.me/tonapi_bot telegram bot. [Learn more about serverside and clientside flows.](#serverside-and-clientside-flows)

Example header:
```
Authorisation: Bearer AppTokenHere
```
**Serverside auth header:**
```javascript
var options = {
    host: 'tonapi.io',
    path: '/v1/nft/getCollections',
    headers: {
        'Authorization': 'Bearer ' + serverSideAppToken,
    }
};
http.request(options, () => {}).end();
```

**Clientside auth header:**
```javascript
var options = {
    method: 'post', 
    headers: new Headers({
        'Authorization': 'Bearer '+clientSideAppToken, 
    }), 
}
fetch("https://tonapi.io/v1/nft/getCollections", options)
```

There are two types of AppTokens that can be generated by t.me/tonapi_bot, serverside token and clientside token.


Following GET params needed by this method:
* **auth_token**, *string*, the token wich was returned by the method below
* **rate_limit**, *number*, request per seconds
* **token_type**, *string [client, server]*, type of token which will be used to indicate the app

**Examples:**
```JSON
{
    "success": true,
    "user_token": "abcd..."
}
```
```JSON
{
    "success": false,
    "error_code": "auth_rejected",
    "error_text": "User canceled authorization"
}
```




## OAuth demo
Simple auth demo using [tonapi.io](https://tonapi.io/), tonkeeper and oauth login flow with desktop and mobile support
[View Demo](https://tonapi-oauth.herokuapp.com/)
Before you looking this demo read the definition of oauth [login flow](https://www.techtarget.com/searchapparchitecture/definition/OAuth) and go oauth [implementation](https://github.com/go-oauth2/oauth2)

***
```javascript
Quick start guide:

1) git clone git@github.com:startfellows/tonapi-oauth-demo.git
2) cd tonapi-oauth-demo
3) yarn
4) yarn start
```

Look at the source code for more [details](https://github.com/startfellows/tonapi-oauth-demo/blob/master/src/App.tsx)


# TONApi authorization

## Serverside and clientside flows

Tonapi can be used both from client side as well as from server side. In some cases from both sizes at the same time. From code perspective there is not much of a difference, but its important to not use serverside token anywhere in client side, and at the same time to use clientside tokens only on client side. The reason for this is because client side token has additional limitations per IP, while serverside token can be banned in case of large amount of flood requests to the api, so should be limited by the developer.

